{% extends 'base.html' %}

{% block title %}Lolei's Journal / Changelog{% endblock %}

{% block content %}
    <h2 id='trying' class="title text-light" style="color : white"><b><a href="/" class="text-info">
        lolei.uk</a> / WASM Test</b>
    </h2>

    <div
    class="card mb-3 bg-dark text-light"
    style="
        max-width: 300mm;
        min-height: 100mm; 
        margin: 0 auto;
    "
    >
        <div class="card-header bg-dark text-light">
            Conway's Game of Life | <a class="text-info" href="https://github.com/loleik/cgol-rust-wasm">Github Repo</a>
        </div>
        <div class="card-body d-flex justify-content-center align-items-start" style="gap: 2rem;">
            <ul 
                class="list-unstyled bg-dark border border-info rounded p-2 mb-0" 
                id="sim" 
                style="max-height: 300px; overflow-y: auto; min-width: 150px;"
            >
            </ul>

            <canvas 
                class="border border-info rounded" 
                id="simCanvas" 
                width="300" 
                height="300"
            ></canvas>

        </div>
    </div>

    <div class="card mb-3 bg-dark text-light p-2" style="max-width: 300mm; margin-left: auto; margin-right: auto;">
        <div class="card-header bg-dark text-light">
            Controls
        </div>
    
        <div class="card-body d-flex justify-content-center align-items-center" style="gap: 1.5rem;">
            <div class="d-flex flex-column">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="pattern" id="glider" checked>
                    <label class="form-check-label text-light" for="glider">
                        Glider
                    </label>
                </div>
    
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="pattern" id="lwss">
                    <label class="form-check-label text-light" for="lwss">
                        LWSS
                    </label>
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="radio" name="pattern" id="mwss">
                    <label class="form-check-label text-light" for="mwss">
                        MWSS
                    </label>
                </div>
            </div>
    
            <div class="d-flex" style="gap: 1rem;">
                <button id="start" class="btn btn-info">Start</button>
                <button id="stop" class="btn btn-info">Stop</button>
            </div>
        </div>
    </div>

    <script type="module">
        import init, { init_world, World, get_cells, get_offset, tick_world } from "/static/wasm/pkg/cgol_rust_wasm.js";

        async function run() {
            await init();

            const startButton = document.getElementById("start");
            const stopButton = document.getElementById("stop");

            let intervalId = null

            startButton.addEventListener("click", () => {
                if (intervalId !== null) return;
                const selectedPattern = document.querySelector('input[name="pattern"]:checked').id;

                if (selectedPattern === "glider") {
                    console.log("Glider selected");
                    var pattern = "[(1,0),(2,1),(0,2),(1,2),(2,2)]"
                } else if (selectedPattern === "lwss") {
                    console.log("LWSS selected");
                    var pattern = "[(0,1),(0,2),(0,3),(1,0),(1,3),(2,3),(3,3),(4,0),(4,2)]";
                } else if (selectedPattern === "mwss") {
                    console.log("MWSS selected");
                    var pattern = "[(11,0),(11,1),(11,2),(12,2),(13,1),(0,7),(1,5),(1,6),(2,6),(2,7),(8,7),(8,6),(8,5),(9,5),(10,6)]";
                }

                let world = init_world(pattern);

                let ul = document.getElementById("sim");
                const canvas = document.getElementById("simCanvas");
                const ctx = canvas.getContext("2d");
                ctx.fillStyle = "white";
                const CELL_SIZE = 5;

                let center = get_offset(world);
                let offset = [
                    (center[0] * CELL_SIZE) - 300 / 2,
                    (center[1] * CELL_SIZE) - 300 / 2
                ]

                function render() {
                    let cells = get_cells(world);

                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    cells.forEach(cell => {
                        const [x, y] = cell;
                        var li = document.createElement("li");
                        li.appendChild(document.createTextNode(`(${x}, ${y})`));
                        ul.appendChild(li);
                        ctx.fillRect(
                            x * CELL_SIZE - offset[0], 
                            y * CELL_SIZE - offset[1], 
                            CELL_SIZE, 
                            CELL_SIZE
                        );
                    })
                }

                stopButton.addEventListener("click", () => {
                    clearInterval(intervalId);
                    intervalId = null;
                    const canvas = document.getElementById("simCanvas");
                    const ctx = canvas.getContext("2d");
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    document.getElementById("sim").innerHTML = "";
                });

                intervalId = setInterval(() => {
                    ul.innerHTML = "";
                    render();
                    tick_world(world);
                }, 500);
            });
        }

        run();
    </script>

{% endblock %}